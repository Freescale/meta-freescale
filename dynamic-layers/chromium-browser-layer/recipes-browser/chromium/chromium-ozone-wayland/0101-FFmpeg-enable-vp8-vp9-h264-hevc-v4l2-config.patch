From 6ca188c138e54d8f82cc20def539eec89fe46ed8 Mon Sep 17 00:00:00 2001
From: Hou Qi <qi.hou@nxp.com>
Date: Thu, 16 Dec 2021 10:01:46 +0800
Subject: [PATCH 1/4] FFmpeg: enable vp8/vp9/h264/hevc v4l2 config

Upstream-Status: Inappropriate [NXP specific]
---
 chromium/config/Chromium/linux/arm64/config.h | 52 ++++++-------
 .../linux/arm64/libavcodec/bsf_list.c         |  2 +
 .../linux/arm64/libavcodec/codec_list.c       |  8 ++
 .../linux/arm64/libavcodec/parser_list.c      |  3 +
 .../linux/arm64/libavformat/demuxer_list.c    |  3 +
 ffmpeg_generated.gni                          | 76 ++++++++++++++++---
 libavcodec/allcodecs.c                        |  9 ++-
 libavcodec/autorename_libavcodec_h264dec.c    |  1 +
 libavcodec/autorename_libavcodec_hevcdec.c    |  1 +
 9 files changed, 115 insertions(+), 40 deletions(-)
 create mode 100644 libavcodec/autorename_libavcodec_h264dec.c
 create mode 100644 libavcodec/autorename_libavcodec_hevcdec.c

Index: chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/config.h
===================================================================
--- chromium-96.0.4664.110.orig/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/config.h
+++ chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/config.h
@@ -550,7 +550,7 @@
 #define CONFIG_VAAPI 0
 #define CONFIG_VDPAU 0
 #define CONFIG_VIDEOTOOLBOX 0
-#define CONFIG_V4L2_M2M 0
+#define CONFIG_V4L2_M2M 1
 #define CONFIG_XVMC 0
 #define CONFIG_FTRAPV 0
 #define CONFIG_GRAY 0
@@ -614,13 +614,13 @@
 #define CONFIG_PROTOCOLS 0
 #define CONFIG_AANDCTTABLES 0
 #define CONFIG_AC3DSP 0
-#define CONFIG_ADTS_HEADER 0
-#define CONFIG_ATSC_A53 0
+#define CONFIG_ADTS_HEADER 1
+#define CONFIG_ATSC_A53 1
 #define CONFIG_AUDIO_FRAME_QUEUE 0
 #define CONFIG_AUDIODSP 0
 #define CONFIG_BLOCKDSP 0
 #define CONFIG_BSWAPDSP 0
-#define CONFIG_CABAC 0
+#define CONFIG_CABAC 1
 #define CONFIG_CBS 0
 #define CONFIG_CBS_AV1 0
 #define CONFIG_CBS_H264 0
@@ -642,12 +642,12 @@
 #define CONFIG_GOLOMB 1
 #define CONFIG_GPLV3 0
 #define CONFIG_H263DSP 0
-#define CONFIG_H264CHROMA 0
-#define CONFIG_H264DSP 0
-#define CONFIG_H264PARSE 0
+#define CONFIG_H264CHROMA 1
+#define CONFIG_H264DSP 1
+#define CONFIG_H264PARSE 1
 #define CONFIG_H264PRED 1
-#define CONFIG_H264QPEL 0
-#define CONFIG_HEVCPARSE 0
+#define CONFIG_H264QPEL 1
+#define CONFIG_HEVCPARSE 1
 #define CONFIG_HPELDSP 1
 #define CONFIG_HUFFMAN 0
 #define CONFIG_HUFFYUVDSP 0
@@ -690,7 +690,7 @@
 #define CONFIG_SINEWIN 0
 #define CONFIG_SNAPPY 0
 #define CONFIG_SRTP 0
-#define CONFIG_STARTCODE 0
+#define CONFIG_STARTCODE 1
 #define CONFIG_TEXTUREDSP 0
 #define CONFIG_TEXTUREDSPENC 0
 #define CONFIG_TPELDSP 0
@@ -714,11 +714,11 @@
 #define CONFIG_EXTRACT_EXTRADATA_BSF 0
 #define CONFIG_FILTER_UNITS_BSF 0
 #define CONFIG_H264_METADATA_BSF 0
-#define CONFIG_H264_MP4TOANNEXB_BSF 0
+#define CONFIG_H264_MP4TOANNEXB_BSF 1
 #define CONFIG_H264_REDUNDANT_PPS_BSF 0
 #define CONFIG_HAPQA_EXTRACT_BSF 0
 #define CONFIG_HEVC_METADATA_BSF 0
-#define CONFIG_HEVC_MP4TOANNEXB_BSF 0
+#define CONFIG_HEVC_MP4TOANNEXB_BSF 1
 #define CONFIG_IMX_DUMP_HEADER_BSF 0
 #define CONFIG_MJPEG2JPEG_BSF 0
 #define CONFIG_MJPEGA_DUMP_HEADER_BSF 0
@@ -823,18 +823,18 @@
 #define CONFIG_H263I_DECODER 0
 #define CONFIG_H263P_DECODER 0
 #define CONFIG_H263_V4L2M2M_DECODER 0
-#define CONFIG_H264_DECODER 0
+#define CONFIG_H264_DECODER 1
 #define CONFIG_H264_CRYSTALHD_DECODER 0
-#define CONFIG_H264_V4L2M2M_DECODER 0
+#define CONFIG_H264_V4L2M2M_DECODER 1
 #define CONFIG_H264_MEDIACODEC_DECODER 0
 #define CONFIG_H264_MMAL_DECODER 0
 #define CONFIG_H264_QSV_DECODER 0
 #define CONFIG_H264_RKMPP_DECODER 0
 #define CONFIG_HAP_DECODER 0
-#define CONFIG_HEVC_DECODER 0
+#define CONFIG_HEVC_DECODER 1
 #define CONFIG_HEVC_QSV_DECODER 0
 #define CONFIG_HEVC_RKMPP_DECODER 0
-#define CONFIG_HEVC_V4L2M2M_DECODER 0
+#define CONFIG_HEVC_V4L2M2M_DECODER 1
 #define CONFIG_HNM4_VIDEO_DECODER 0
 #define CONFIG_HQ_HQA_DECODER 0
 #define CONFIG_HQX_DECODER 0
@@ -994,10 +994,10 @@
 #define CONFIG_VP7_DECODER 0
 #define CONFIG_VP8_DECODER 1
 #define CONFIG_VP8_RKMPP_DECODER 0
-#define CONFIG_VP8_V4L2M2M_DECODER 0
-#define CONFIG_VP9_DECODER 0
+#define CONFIG_VP8_V4L2M2M_DECODER 1
+#define CONFIG_VP9_DECODER 1
 #define CONFIG_VP9_RKMPP_DECODER 0
-#define CONFIG_VP9_V4L2M2M_DECODER 0
+#define CONFIG_VP9_V4L2M2M_DECODER 1
 #define CONFIG_VQA_DECODER 0
 #define CONFIG_WEBP_DECODER 0
 #define CONFIG_WCMV_DECODER 0
@@ -1023,7 +1023,7 @@
 #define CONFIG_ZEROCODEC_DECODER 0
 #define CONFIG_ZLIB_DECODER 0
 #define CONFIG_ZMBV_DECODER 0
-#define CONFIG_AAC_DECODER 0
+#define CONFIG_AAC_DECODER 1
 #define CONFIG_AAC_FIXED_DECODER 0
 #define CONFIG_AAC_LATM_DECODER 0
 #define CONFIG_AC3_DECODER 0
@@ -1585,7 +1585,7 @@
 #define CONFIG_WMV3_NVDEC_HWACCEL 0
 #define CONFIG_WMV3_VAAPI_HWACCEL 0
 #define CONFIG_WMV3_VDPAU_HWACCEL 0
-#define CONFIG_AAC_PARSER 0
+#define CONFIG_AAC_PARSER 1
 #define CONFIG_AAC_LATM_PARSER 0
 #define CONFIG_AC3_PARSER 0
 #define CONFIG_ADX_PARSER 0
@@ -1612,8 +1612,8 @@
 #define CONFIG_GSM_PARSER 0
 #define CONFIG_H261_PARSER 0
 #define CONFIG_H263_PARSER 0
-#define CONFIG_H264_PARSER 0
-#define CONFIG_HEVC_PARSER 0
+#define CONFIG_H264_PARSER 1
+#define CONFIG_HEVC_PARSER 1
 #define CONFIG_IPU_PARSER 0
 #define CONFIG_JPEG2000_PARSER 0
 #define CONFIG_MJPEG_PARSER 0
@@ -2169,7 +2169,7 @@
 #define CONFIG_AFIFO_FILTER 0
 #define CONFIG_FIFO_FILTER 0
 #define CONFIG_AA_DEMUXER 0
-#define CONFIG_AAC_DEMUXER 0
+#define CONFIG_AAC_DEMUXER 1
 #define CONFIG_AAX_DEMUXER 0
 #define CONFIG_AC3_DEMUXER 0
 #define CONFIG_ACE_DEMUXER 0
@@ -2274,10 +2274,10 @@
 #define CONFIG_GXF_DEMUXER 0
 #define CONFIG_H261_DEMUXER 0
 #define CONFIG_H263_DEMUXER 0
-#define CONFIG_H264_DEMUXER 0
+#define CONFIG_H264_DEMUXER 1
 #define CONFIG_HCA_DEMUXER 0
 #define CONFIG_HCOM_DEMUXER 0
-#define CONFIG_HEVC_DEMUXER 0
+#define CONFIG_HEVC_DEMUXER 1
 #define CONFIG_HLS_DEMUXER 0
 #define CONFIG_HNM_DEMUXER 0
 #define CONFIG_ICO_DEMUXER 0
Index: chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/bsf_list.c
===================================================================
--- chromium-96.0.4664.110.orig/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/bsf_list.c
+++ chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/bsf_list.c
@@ -1,3 +1,5 @@
 static const AVBitStreamFilter * const bitstream_filters[] = {
+    &ff_h264_mp4toannexb_bsf,
+    &ff_hevc_mp4toannexb_bsf,
     &ff_null_bsf,
     NULL };
Index: chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/codec_list.c
===================================================================
--- chromium-96.0.4664.110.orig/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/codec_list.c
+++ chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/codec_list.c
@@ -1,4 +1,12 @@
 static const AVCodec * const codec_list[] = {
+    &ff_vp8_v4l2m2m_decoder,
+    &ff_vp9_v4l2m2m_decoder,
+    &ff_h264_v4l2m2m_decoder,
+    &ff_hevc_v4l2m2m_decoder,
+    &ff_vp9_decoder,
+    &ff_h264_decoder,
+    &ff_hevc_decoder,
+    &ff_aac_decoder,
     &ff_theora_decoder,
     &ff_vp3_decoder,
     &ff_vp8_decoder,
Index: chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/parser_list.c
===================================================================
--- chromium-96.0.4664.110.orig/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/parser_list.c
+++ chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavcodec/parser_list.c
@@ -1,4 +1,7 @@
 static const AVCodecParser * const parser_list[] = {
+    &ff_h264_parser,
+    &ff_hevc_parser,
+    &ff_aac_parser,
     &ff_flac_parser,
     &ff_mpegaudio_parser,
     &ff_opus_parser,
Index: chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavformat/demuxer_list.c
===================================================================
--- chromium-96.0.4664.110.orig/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavformat/demuxer_list.c
+++ chromium-96.0.4664.110/third_party/ffmpeg/chromium/config/Chromium/linux/arm64/libavformat/demuxer_list.c
@@ -1,4 +1,7 @@
 static const AVInputFormat * const demuxer_list[] = {
+    &ff_h264_demuxer,
+    &ff_hevc_demuxer,
+    &ff_aac_demuxer,
     &ff_flac_demuxer,
     &ff_matroska_demuxer,
     &ff_mov_demuxer,
Index: chromium-96.0.4664.110/third_party/ffmpeg/ffmpeg_generated.gni
===================================================================
--- chromium-96.0.4664.110.orig/third_party/ffmpeg/ffmpeg_generated.gni
+++ chromium-96.0.4664.110/third_party/ffmpeg/ffmpeg_generated.gni
@@ -208,9 +208,49 @@ if ((is_mac) || (is_win) || (use_linux_c
     "libavcodec/vp8.c",
     "libavcodec/vp8_parser.c",
   ]
+
+  ffmpeg_c_sources += [
+    "libavcodec/v4l2_m2m_dec.c",
+    "libavcodec/v4l2_buffers.c",
+    "libavcodec/v4l2_context.c",
+    "libavcodec/v4l2_m2m.c",
+    "libavcodec/v4l2_fmt.c",
+  ]
+  ffmpeg_c_sources += [
+    "libavcodec/vp9.c",
+    "libavcodec/vp9data.c",
+    "libavcodec/vp9lpf.c",
+    "libavcodec/vp9recon.c",
+    "libavcodec/vp9block.c",
+    "libavcodec/vp9prob.c",
+    "libavcodec/vp9mvs.c",
+    "libavcodec/vp9dsp.c",
+    "libavcodec/vp9dsp_8bpp.c",
+    "libavcodec/vp9dsp_10bpp.c",
+    "libavcodec/vp9dsp_12bpp.c",
+  ]
+  ffmpeg_c_sources += [
+    "libavcodec/dynamic_hdr10_plus.c",
+    "libavcodec/bswapdsp.c",
+    "libavcodec/hevc_cabac.c",
+    "libavcodec/hevc_data.c",
+    "libavcodec/hevc_filter.c",
+    "libavcodec/hevc_mvs.c",
+    "libavcodec/hevc_parse.c",
+    "libavcodec/hevc_parser.c",
+    "libavcodec/hevc_ps.c",
+    "libavcodec/hevc_refs.c",
+    "libavcodec/hevc_sei.c",
+    "libavcodec/hevcdsp.c",
+    "libavcodec/hevcpred.c",
+    "libavcodec/autorename_libavcodec_hevcdec.c",
+    "libavformat/hevc.c",
+    "libavformat/hevcdec.c",
+    "libavcodec/hevc_mp4toannexb_bsf.c",
+  ]
 }
 
-if ((current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_android && current_cpu == "arm" && arm_use_neon && ffmpeg_branding == "Chrome") || (is_android && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (is_mac && ffmpeg_branding == "Chrome") || (is_win && ffmpeg_branding == "Chrome") || (use_linux_config && ffmpeg_branding == "Chrome") || (use_linux_config && ffmpeg_branding == "ChromeOS")) {
+if ((current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_android && current_cpu == "arm" && arm_use_neon && ffmpeg_branding == "Chrome") || (is_android && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (is_mac && ffmpeg_branding == "Chrome") || (is_win && ffmpeg_branding == "Chrome") || (use_linux_config && ffmpeg_branding == "Chrome") || (use_linux_config)) {
   ffmpeg_c_sources += [
     "libavcodec/aac_ac3_parser.c",
     "libavcodec/aac_parser.c",
@@ -249,7 +289,7 @@ if ((is_android && current_cpu == "x64")
   ]
 }
 
-if ((is_mac && ffmpeg_branding == "Chrome") || (is_win && ffmpeg_branding == "Chrome") || (use_linux_config && ffmpeg_branding == "Chrome") || (use_linux_config && ffmpeg_branding == "ChromeOS")) {
+if ((is_mac && ffmpeg_branding == "Chrome") || (is_win && ffmpeg_branding == "Chrome") || (use_linux_config && ffmpeg_branding == "Chrome") || (use_linux_config)) {
   ffmpeg_c_sources += [
     "libavcodec/atsc_a53.c",
     "libavcodec/cabac.c",
@@ -268,12 +308,14 @@ if ((is_mac && ffmpeg_branding == "Chrom
     "libavcodec/h264_slice.c",
     "libavcodec/h264chroma.c",
     "libavcodec/h264data.c",
-    "libavcodec/h264dec.c",
+    "libavcodec/autorename_libavcodec_h264dec.c",
     "libavcodec/h264dsp.c",
     "libavcodec/h264idct.c",
     "libavcodec/h264qpel.c",
     "libavcodec/h274.c",
     "libavcodec/startcode.c",
+    "libavformat/h264dec.c",
+    "libavcodec/h264_mp4toannexb_bsf.c",
   ]
 }
 
@@ -332,7 +374,7 @@ if ((is_android && current_cpu == "arm64
   ]
 }
 
-if ((current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_android && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x64" && ffmpeg_branding == "ChromeOS") || (use_linux_config && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x86" && ffmpeg_branding == "ChromeOS")) {
+if ((current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_android && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x64" && ffmpeg_branding == "ChromeOS") || (use_linux_config && current_cpu == "x86")) {
   ffmpeg_c_sources += [
     "libavcodec/x86/aacpsdsp_init.c",
     "libavcodec/x86/mdct15_init.c",
@@ -340,7 +382,7 @@ if ((current_cpu == "x64" && ffmpeg_bran
   ]
 }
 
-if ((current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x64" && ffmpeg_branding == "ChromeOS") || (use_linux_config && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x86" && ffmpeg_branding == "ChromeOS")) {
+if ((current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x64" && ffmpeg_branding == "ChromeOS") || (use_linux_config && current_cpu == "x86")) {
   ffmpeg_asm_sources += [
     "libavcodec/x86/aacpsdsp.asm",
     "libavcodec/x86/mdct15.asm",
@@ -374,7 +416,7 @@ if ((is_android && current_cpu == "arm"
   ]
 }
 
-if ((is_mac && current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x64" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x64" && ffmpeg_branding == "ChromeOS") || (use_linux_config && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x86" && ffmpeg_branding == "ChromeOS")) {
+if ((is_mac && current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "x86" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "x64") || (use_linux_config && current_cpu == "x86")) {
   ffmpeg_c_sources += [
     "libavcodec/x86/h264_qpel.c",
     "libavcodec/x86/h264chroma_init.c",
@@ -401,6 +443,20 @@ if ((is_mac && current_cpu == "arm64") |
     "libavcodec/aarch64/hpeldsp_init_aarch64.c",
     "libavcodec/aarch64/videodsp_init.c",
     "libavcodec/aarch64/vp8dsp_init_aarch64.c",
+    "libavcodec/aarch64/vp9dsp_init_aarch64.c",
+    "libavcodec/aarch64/vp9dsp_init_12bpp_aarch64.c",
+    "libavcodec/aarch64/vp9dsp_init_10bpp_aarch64.c",
+    "libavcodec/aarch64/vp9dsp_init_16bpp_aarch64_template.c",
+    "libavcodec/aarch64/hevcdsp_init_aarch64.c",
+    "libavcodec/aarch64/vp9mc_neon.S",
+    "libavcodec/aarch64/vp9mc_aarch64.S",
+    "libavcodec/aarch64/vp9lpf_neon.S",
+    "libavcodec/aarch64/vp9lpf_16bpp_neon.S",
+    "libavcodec/aarch64/vp9mc_16bpp_neon.S",
+    "libavcodec/aarch64/vp9itxfm_neon.S",
+    "libavcodec/aarch64/vp9itxfm_16bpp_neon.S",
+    "libavcodec/aarch64/hevcdsp_idct_neon.S",
+    "libavcodec/aarch64/hevcdsp_sao_neon.S",
   ]
   ffmpeg_gas_sources += [
     "libavcodec/aarch64/autorename_libavcodec_aarch64_h264pred_neon.S",
@@ -410,7 +466,7 @@ if ((is_mac && current_cpu == "arm64") |
   ]
 }
 
-if ((current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "arm64" && ffmpeg_branding == "ChromeOS")) {
+if ((current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "arm64")) {
   ffmpeg_c_sources += [
     "libavcodec/aarch64/aacpsdsp_init_aarch64.c",
     "libavcodec/aarch64/sbrdsp_init_aarch64.c",
@@ -421,7 +477,7 @@ if ((current_cpu == "arm64" && ffmpeg_br
   ]
 }
 
-if ((is_mac && current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "arm64" && ffmpeg_branding == "ChromeOS")) {
+if ((is_mac && current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (is_win && current_cpu == "arm64" && ffmpeg_branding == "Chrome") || (use_linux_config && current_cpu == "arm64")) {
   ffmpeg_c_sources += [
     "libavcodec/aarch64/h264chroma_init_aarch64.c",
     "libavcodec/aarch64/h264dsp_init_aarch64.c",
@@ -583,7 +639,7 @@ if (use_linux_config && current_cpu == "
   ]
 }
 
-if ((use_linux_config && current_cpu == "arm" && arm_use_neon && ffmpeg_branding == "ChromeOS") || (use_linux_config && current_cpu == "arm64" && ffmpeg_branding == "ChromeOS")) {
+if ((use_linux_config && current_cpu == "arm" && arm_use_neon && ffmpeg_branding == "ChromeOS") || (use_linux_config && current_cpu == "arm64")) {
   ffmpeg_c_sources += [
     "libavcodec/neon/mpegvideo.c",
   ]
@@ -622,7 +678,7 @@ if ((use_linux_config && current_cpu ==
   ]
 }
 
-if (use_linux_config && current_cpu == "arm64" && ffmpeg_branding == "ChromeOS") {
+if (use_linux_config && current_cpu == "arm64") {
   ffmpeg_c_sources += [
     "libavcodec/aarch64/idctdsp_init_aarch64.c",
     "libavcodec/aarch64/pixblockdsp_init_aarch64.c",
Index: chromium-96.0.4664.110/third_party/ffmpeg/libavcodec/allcodecs.c
===================================================================
--- chromium-96.0.4664.110.orig/third_party/ffmpeg/libavcodec/allcodecs.c
+++ chromium-96.0.4664.110/third_party/ffmpeg/libavcodec/allcodecs.c
@@ -32,6 +32,11 @@
 #include "codec.h"
 #include "codec_id.h"
 
+extern const AVCodec ff_vp8_v4l2m2m_decoder;
+extern const AVCodec ff_vp9_v4l2m2m_decoder;
+extern const AVCodec ff_h264_v4l2m2m_decoder;
+extern const AVCodec ff_hevc_v4l2m2m_decoder;
+
 extern const AVCodec ff_a64multi_encoder;
 extern const AVCodec ff_a64multi5_encoder;
 extern const AVCodec ff_aasc_decoder;
@@ -146,7 +151,6 @@ extern const AVCodec ff_h263p_decoder;
 extern const AVCodec ff_h263_v4l2m2m_decoder;
 extern const AVCodec ff_h264_decoder;
 extern const AVCodec ff_h264_crystalhd_decoder;
-extern const AVCodec ff_h264_v4l2m2m_decoder;
 extern const AVCodec ff_h264_mediacodec_decoder;
 extern const AVCodec ff_h264_mmal_decoder;
 extern const AVCodec ff_h264_qsv_decoder;
@@ -156,7 +160,6 @@ extern const AVCodec ff_hap_decoder;
 extern const AVCodec ff_hevc_decoder;
 extern const AVCodec ff_hevc_qsv_decoder;
 extern const AVCodec ff_hevc_rkmpp_decoder;
-extern const AVCodec ff_hevc_v4l2m2m_decoder;
 extern const AVCodec ff_hnm4_video_decoder;
 extern const AVCodec ff_hq_hqa_decoder;
 extern const AVCodec ff_hqx_decoder;
@@ -362,10 +365,8 @@ extern const AVCodec ff_vp6f_decoder;
 extern const AVCodec ff_vp7_decoder;
 extern const AVCodec ff_vp8_decoder;
 extern const AVCodec ff_vp8_rkmpp_decoder;
-extern const AVCodec ff_vp8_v4l2m2m_decoder;
 extern const AVCodec ff_vp9_decoder;
 extern const AVCodec ff_vp9_rkmpp_decoder;
-extern const AVCodec ff_vp9_v4l2m2m_decoder;
 extern const AVCodec ff_vqa_decoder;
 extern const AVCodec ff_webp_decoder;
 extern const AVCodec ff_wcmv_decoder;
Index: chromium-96.0.4664.110/third_party/ffmpeg/libavcodec/autorename_libavcodec_h264dec.c
===================================================================
--- /dev/null
+++ chromium-96.0.4664.110/third_party/ffmpeg/libavcodec/autorename_libavcodec_h264dec.c
@@ -0,0 +1 @@
+#include "h264dec.c"
Index: chromium-96.0.4664.110/third_party/ffmpeg/libavcodec/autorename_libavcodec_hevcdec.c
===================================================================
--- /dev/null
+++ chromium-96.0.4664.110/third_party/ffmpeg/libavcodec/autorename_libavcodec_hevcdec.c
@@ -0,0 +1 @@
+#include "hevcdec.c"
